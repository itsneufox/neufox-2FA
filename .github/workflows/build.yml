name: Build and Release

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, Win32]
        config: [RelWithDebInfo]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'latest'
    
    - name: Install dependencies
      run: |
        vcpkg install glm:${{ matrix.arch }}-windows
        vcpkg install robin-hood-hashing:${{ matrix.arch }}-windows
        vcpkg install span-lite:${{ matrix.arch }}-windows
        vcpkg install string-view-lite:${{ matrix.arch }}-windows
        vcpkg install openssl:${{ matrix.arch }}-windows
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake
    
    - name: Build
      run: |
        cd build
        cmake --build . --config ${{ matrix.config }}
    
    - name: Package artifacts
      run: |
        $arch = "${{ matrix.arch }}" -replace "Win32", "x86"
        mkdir artifacts
        Copy-Item "build/${{ matrix.config }}/neufox-2fa-*.dll" artifacts/
        Copy-Item "build/${{ matrix.config }}/neufox-2fa-*.pdb" artifacts/
        Copy-Item "build/${{ matrix.config }}/libcrypto-*.dll" artifacts/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neufox-2fa-windows-${{ matrix.arch }}-${{ matrix.config }}
        path: artifacts/*

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container: ['ubuntu:20.04', 'ubuntu:22.04']
    
    container: ${{ matrix.container }}
    
    steps:
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y git cmake build-essential libssl-dev
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo
    
    - name: Build
      run: |
        cd build
        cmake --build .
    
    - name: Package artifacts
      run: |
        mkdir artifacts
        cp build/neufox-2fa-*.so artifacts/ || true
        cp build/libcrypto.so.3 artifacts/ || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neufox-2fa-${{ matrix.container }}-x64
        path: artifacts/*

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

